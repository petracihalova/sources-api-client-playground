# Sources API client PLAYGROUND
generated by https://github.com/deepmap/oapi-codegen 

LINKS:
- [OpenAPI-Specification - parameters](https://github.com/OAI/OpenAPI-Specification/blob/main/versions/3.0.0.md#parameter-object)
- [OpenAPI-Specification - issue 1706: Support deep objects for query parameters with deepObject style](https://github.com/OAI/OpenAPI-Specification/issues/1706)
- [Swagger.io - OpenAPI Guide - Parameter Serialization](https://swagger.io/docs/specification/serialization/)


ABOUT:

This playground was crated to solve issue with using specific filter in ```/api/sources/v3.1/sources``` endpoint in generated api client. Every branch contains different style of query parameters in open api spec. Main issue described in MAIN branch.


## branch MAIN
- default version
- openApi spec without changes = same version as in sources-api-go repo
- api client is same as is used by provisioning team
- desired filter is ```/sources?filter[source_type][name]=ibm ```
- ParseFilter() function in sources middleware is expecting filter in this structure:
  - key: ```filter[source_type][name]```
  - value: ```ibm```
- direct api request via Postman is working:
```
GET http://localhost:8000/api/sources/v3.1/sources?filter[source_type][name]=ibm
```

Structure of filter in open api spec:
```
"QueryFilter": {
    "in": "query",
    "name": "filter",
    "description": "Filter for querying collections. The format of the filters is as follows: `filter[subresource][field][operation]=\"value\"`.\n",
    "example": "filter[name][eq]=\"My shiny source\"\n",
    "schema": {
        "type": "string"
  }
```

### RESULTS => NOT WORKING
- generated API client creates query parameter with:
    - key: ```filter```
    - value: ```[source_type][name]=ibm```

## branch DEEP OBJECT
- used deepObject in open api spec
```
"QueryFilter": {
    "in": "query",
    "name": "filter",
    "style": "deepObject",
    "description": "Filter for querying collections. The format of the filters is as follows: `filter[subresource][field][operation]=\"value\"`.\n",
    "example": "filter[name][eq]=\"My shiny source\"\n",
    "schema": {
        "type": "object",
        "properties": {
            "subresource": {
                "type": "string"
            },
            "field": {
                "type": "string"
            },
            "operation": {
                "type": "string"
            },
            "value": {
                "type": "string"
            }
        }
    }
}
```
### RESULTS => NOT WORKING
- generated API client creates 3 query parameter with:
  - key: ```filter[subresource]```, value: ```source_type```
  - key: ```filter[field]```, value: ```name```
  - key: ```filter[value]```, value: ```ibm```
- problem is that name of desired subresource or field is not dynamically changed and we dont want to define in open api spec all options like "source_type" and "application_type" as subresource and all possible names for property "field"
- result with generated api is:

```{"errors":[{"detail":"bad request: ERROR: column sources.field does not exist (SQLSTATE 42703)","status":"400"}]}```

## branch ARRAY
- used schema style = array in open api spec
```
"QueryFilter": {
    "in": "query",
    "name": "filter",
    "description": "Filter for querying collections. The format of the filters is as follows: `filter[subresource][field][operation]=\"value\"`.\n",
    "example": "filter[name][eq]=\"My shiny source\"\n",
      "schema": {
          "type": "array",
          "items": {
             "type": "string"
          }
      },
    "style": "form",
    "explode": false
},
```

### RESULTS => NOT WORKING
- generated API client creates query parameter with:
  - key: ```filter```
  - value: ```source_type, name, ibm```


## branch DEEP OBJECT 2
- used deepObject in open api spec
- the names of fields are not specified (additional properties with type string creates in generated client the struct that needs ```map[string]string```)
```
"QueryFilter": {
    "in": "query",
    "name": "filter",
    "style": "deepObject",
    "description": "Filter for querying collections. The format of the filters is as follows: `filter[subresource][field][operation]=\"value\"`.\n",
    "example": "filter[name][eq]=\"My shiny source\"\n",
    "schema": {
        "type": "object",
        "additionalProperties": {
            "type": "string"
        }
    }
},
```
- in our handlers we can define filter as ```map[string][string]``` with:
    - key: ```[source_type][name]```
    - value: ```ibm```

example:
```
filter := ListSourcesParams_Filter{map[string]string{"[source_type][name]": "ibm"}}
```

### RESULTS => WORKING + needs changes only in "QueryFilter" definition (on Sources side)
- generated API client creates query parameter with:
   - key: ```[[source_type][name]]```
   - value: ```ibm```
- so there is one more [] around key but method ```FindAllStringSubmatch()``` used in ```middleware/filtering.go``` can process it correctly


## branch DEEP OBJECT 3
- used deepObject in open api spec
- I created special filter for sources (QueryFilterSourceType) and applications (QueryFilterApplicationType) and I set all possible fields we can use for filtering (like "name", "id", "vendor" ....)

example
```
"QueryFilterSourceType": {
  "in": "query",
  "name": "filter",
  "style": "deepObject",
  "description": "Filter the sources with source type. The format of the filters is as follows: `filter[source_type][field][operation]=\"value\"`.\n",
  "example": "filter[source_type][name][eq]=\"source type name\"\n",
  "schema": {
    "type": "object",
    "properties": {
      "source_type": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "name": {
            "type": "string"
          },
          "product_name": {
            "type": "string"
          },
          "vendor": {
            "type": "string"
          },
          "category": {
            "type": "string"
          }
        }
      }
    }
  }
},
```

- this creates in generated client the struct ```QueryFilterSourceType```
```
// QueryFilterSourceType defines model for QueryFilterSourceType.
type QueryFilterSourceType struct {
	SourceType *struct {
		Category    *string `json:"category,omitempty"`
		Id          *int    `json:"id,omitempty"`
		Name        *string `json:"name,omitempty"`
		ProductName *string `json:"product_name,omitempty"`
		Vendor      *string `json:"vendor,omitempty"`
	} `json:"source_type,omitempty"`
}
```

- we can use it to define our desired filter 